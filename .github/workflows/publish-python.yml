name: Build and Publish Python Package

on:
  workflow_dispatch:
    inputs:
      cdk_version:
        description: 'CDK version/tag to build (e.g., v0.4.0)'
        required: true
        type: string
      publish_target:
        description: 'Publishing target'
        required: false
        default: 'none'
        type: choice
        options:
          - none        # Build only, no publishing
          - test-pypi   # Publish to TestPyPI
          - pypi        # Publish to production PyPI
      skip_version_commit:
        description: 'Skip committing version changes (for testing)'
        required: false
        default: 'false'
        type: string
      build_platforms:
        description: 'Platforms to build (comma-separated, or "all")'
        required: false
        default: 'all'
        type: string
  repository_dispatch:
    types: [cdk-release]

permissions:
  contents: write      # For GitHub releases
  id-token: write      # For trusted publishing to PyPI

jobs:
  validate-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cdk-python repository
        uses: actions/checkout@v4.2.2

      - name: Validate required scripts exist
        run: |
          echo "ðŸ” Validating required scripts..."
          SCRIPTS=(
            "scripts/find-python.sh"
            "scripts/generate-linux-x86_64.sh"
            "scripts/generate-linux-aarch64-native.sh"
            "scripts/generate-macos-x86_64.sh"
            "scripts/generate-macos-arm64.sh"
            "scripts/generate-windows-x86_64.sh"
          )

          MISSING_SCRIPTS=()
          for script in "${SCRIPTS[@]}"; do
            if [ ! -f "$script" ]; then
              echo "âŒ Missing: $script"
              MISSING_SCRIPTS+=("$script")
            else
              echo "âœ… Found: $script"
              if [ ! -x "$script" ]; then
                echo "âš ï¸  Warning: $script is not executable"
              fi
            fi
          done

          if [ ${#MISSING_SCRIPTS[@]} -gt 0 ]; then
            echo ""
            echo "âŒ Error: Missing required scripts:"
            printf '%s\n' "${MISSING_SCRIPTS[@]}"
            exit 1
          fi

          echo ""
          echo "âœ… All required scripts found!"

  update-version:
    needs: validate-workflow
    runs-on: ubuntu-latest
    outputs:
      cdk_version: ${{ steps.extract_version.outputs.version }}
      commit_sha: ${{ steps.commit.outputs.commit_sha }}
    steps:
      - name: Checkout cdk-python repository
        uses: actions/checkout@v4.2.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout CDK repository
        uses: actions/checkout@v4.2.2
        with:
          repository: cashubtc/cdk
          path: cdk
          ref: ${{ github.event.client_payload.version || github.event.inputs.cdk_version }}
        continue-on-error: true
        id: checkout_cdk

      - name: Retry CDK checkout on failure
        if: steps.checkout_cdk.outcome == 'failure'
        run: |
          echo "First checkout attempt failed, retrying..."
          sleep 5
          rm -rf cdk || true
          git clone --depth 1 --branch ${{ github.event.client_payload.version || github.event.inputs.cdk_version }} https://github.com/cashubtc/cdk.git cdk

      - name: Extract version from CDK
        id: extract_version
        run: |
          # Extract version from CDK Cargo.toml (remove 'v' prefix if present)
          CDK_TAG="${{ github.event.client_payload.version || github.event.inputs.cdk_version }}"
          CDK_VERSION="${CDK_TAG#v}"

          echo "CDK tag: $CDK_TAG"
          echo "CDK version: $CDK_VERSION"
          echo "version=$CDK_VERSION" >> $GITHUB_OUTPUT

      - name: Update pyproject.toml version
        run: |
          VERSION="${{ steps.extract_version.outputs.version }}"

          # Update version in pyproject.toml
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml

          # Update version in __init__.py
          sed -i "s/^__version__ = .*/__version__ = \"$VERSION\"  # Updated automatically by CI during release/" src/cdk/__init__.py

          # Verify the changes
          echo "Updated pyproject.toml:"
          grep "^version = " pyproject.toml
          echo ""
          echo "Updated __init__.py:"
          grep "^__version__ = " src/cdk/__init__.py

      - name: Commit version update
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          SKIP_COMMIT="${{ github.event.inputs.skip_version_commit || 'false' }}"

          if git diff --quiet pyproject.toml src/cdk/__init__.py; then
            echo "No version changes to commit"
            COMMIT_SHA="${{ github.sha }}"
          elif [ "$SKIP_COMMIT" = "true" ]; then
            echo "âš ï¸  Skipping version commit (test mode)"
            COMMIT_SHA="${{ github.sha }}"
          else
            git add pyproject.toml src/cdk/__init__.py
            git commit -m "chore: bump version to ${{ steps.extract_version.outputs.version }}"
            git push
            COMMIT_SHA=$(git rev-parse HEAD)
          fi

          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Commit SHA: $COMMIT_SHA"

      - name: Upload version files
        uses: actions/upload-artifact@v4.4.3
        with:
          name: version-files
          path: |
            pyproject.toml
            src/cdk/__init__.py

  build-linux-x86_64:
    needs: update-version
    runs-on: ubuntu-latest
    container: quay.io/pypa/manylinux_2_28_x86_64
    if: contains(github.event.inputs.build_platforms, 'all') || contains(github.event.inputs.build_platforms, 'linux-x86_64')
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          ref: ${{ needs.update-version.outputs.commit_sha }}

      - name: Download version files
        uses: actions/download-artifact@v4.1.8
        with:
          name: version-files
          path: .

      - name: Checkout CDK repository
        uses: actions/checkout@v4.2.2
        with:
          repository: cashubtc/cdk
          path: cdk
          ref: ${{ github.event.client_payload.version || github.event.inputs.cdk_version }}
        continue-on-error: true
        id: checkout_cdk

      - name: Retry CDK checkout on failure
        if: steps.checkout_cdk.outcome == 'failure'
        run: |
          echo "First checkout attempt failed, retrying..."
          sleep 5
          rm -rf cdk || true
          git clone --depth 1 --branch ${{ github.event.client_payload.version || github.event.inputs.cdk_version }} https://github.com/cashubtc/cdk.git cdk

      - name: Set up Python ${{ matrix.python-version }}
        run: |
          # Use helper script to find Python binary
          PYTHON_BIN=$(./scripts/find-python.sh ${{ matrix.python-version }})
          echo "Using Python: $PYTHON_BIN"
          $PYTHON_BIN --version
          $PYTHON_BIN -m pip install --upgrade pip
          $PYTHON_BIN -m pip install build wheel

      - name: Install system dependencies
        run: |
          yum install -y openssl-devel pkg-config

      - name: Setup Rust cache
        uses: actions/cache@v4.1.2
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git
            ./cdk/target
          key: ${{ runner.os }}-cargo-linux-x86_64-${{ hashFiles('cdk/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-linux-x86_64-
            ${{ runner.os }}-cargo-

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup target add x86_64-unknown-linux-gnu

      - name: Build wheel
        run: |
          source $HOME/.cargo/env
          chmod +x scripts/generate-linux-x86_64.sh
          ./scripts/generate-linux-x86_64.sh

          # Use helper script to find Python binary
          PYTHON_BIN=$(./scripts/find-python.sh ${{ matrix.python-version }})
          echo "Building wheel with: $PYTHON_BIN"
          $PYTHON_BIN -m build --wheel

      - name: Repair wheel with auditwheel
        run: |
          # Install auditwheel using helper script
          PYTHON_BIN=$(./scripts/find-python.sh ${{ matrix.python-version }})
          $PYTHON_BIN -m pip install auditwheel

          # Repair the wheel to add manylinux tag
          mkdir -p wheelhouse
          for whl in dist/*.whl; do
            auditwheel repair "$whl" --plat manylinux_2_28_x86_64 -w wheelhouse/
          done

          # Replace dist with repaired wheels
          rm -rf dist
          mv wheelhouse dist

      - name: Upload wheel
        uses: actions/upload-artifact@v4.4.3
        with:
          name: wheel-linux-x86_64-py${{ matrix.python-version }}
          path: dist/*.whl

  build-linux-aarch64:
    needs: update-version
    runs-on: ubuntu-latest
    container: quay.io/pypa/manylinux_2_28_aarch64
    if: contains(github.event.inputs.build_platforms, 'all') || contains(github.event.inputs.build_platforms, 'linux-aarch64')
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3.2.0
        with:
          platforms: arm64

      - uses: actions/checkout@v4.2.2
        with:
          ref: ${{ needs.update-version.outputs.commit_sha }}

      - name: Download version files
        uses: actions/download-artifact@v4.1.8
        with:
          name: version-files
          path: .

      - name: Checkout CDK repository
        uses: actions/checkout@v4.2.2
        with:
          repository: cashubtc/cdk
          path: cdk
          ref: ${{ github.event.client_payload.version || github.event.inputs.cdk_version }}
        continue-on-error: true
        id: checkout_cdk

      - name: Retry CDK checkout on failure
        if: steps.checkout_cdk.outcome == 'failure'
        run: |
          echo "First checkout attempt failed, retrying..."
          sleep 5
          rm -rf cdk || true
          git clone --depth 1 --branch ${{ github.event.client_payload.version || github.event.inputs.cdk_version }} https://github.com/cashubtc/cdk.git cdk

      - name: Set up Python ${{ matrix.python-version }}
        run: |
          # Use helper script to find Python binary
          PYTHON_BIN=$(./scripts/find-python.sh ${{ matrix.python-version }})
          echo "Using Python: $PYTHON_BIN"
          $PYTHON_BIN --version
          $PYTHON_BIN -m pip install --upgrade pip
          $PYTHON_BIN -m pip install build wheel

      - name: Install system dependencies
        run: |
          yum install -y openssl-devel pkg-config

      - name: Setup Rust cache
        uses: actions/cache@v4.1.2
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git
            ./cdk/target
          key: ${{ runner.os }}-cargo-linux-aarch64-${{ hashFiles('cdk/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-linux-aarch64-
            ${{ runner.os }}-cargo-

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup target add aarch64-unknown-linux-gnu

      - name: Build wheel
        run: |
          source $HOME/.cargo/env
          # Note: Running natively in aarch64 container via QEMU, but still need
          # to specify target for reproducibility
          chmod +x scripts/generate-linux-aarch64-native.sh
          ./scripts/generate-linux-aarch64-native.sh

          # Use helper script to find Python binary
          PYTHON_BIN=$(./scripts/find-python.sh ${{ matrix.python-version }})
          echo "Building wheel with: $PYTHON_BIN"
          $PYTHON_BIN -m build --wheel

      - name: Repair wheel with auditwheel
        run: |
          # Install auditwheel using helper script
          PYTHON_BIN=$(./scripts/find-python.sh ${{ matrix.python-version }})
          $PYTHON_BIN -m pip install auditwheel

          # Repair the wheel to add manylinux tag
          mkdir -p wheelhouse
          for whl in dist/*.whl; do
            auditwheel repair "$whl" --plat manylinux_2_28_aarch64 -w wheelhouse/
          done

          # Replace dist with repaired wheels
          rm -rf dist
          mv wheelhouse dist

      - name: Upload wheel
        uses: actions/upload-artifact@v4.4.3
        with:
          name: wheel-linux-aarch64-py${{ matrix.python-version }}
          path: dist/*.whl

  build-macos-arm64:
    needs: update-version
    runs-on: macos-14
    if: contains(github.event.inputs.build_platforms, 'all') || contains(github.event.inputs.build_platforms, 'macos-arm64')
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          ref: ${{ needs.update-version.outputs.commit_sha }}

      - name: Download version files
        uses: actions/download-artifact@v4.1.8
        with:
          name: version-files
          path: .

      - name: Checkout CDK repository
        uses: actions/checkout@v4.2.2
        with:
          repository: cashubtc/cdk
          path: cdk
          ref: ${{ github.event.client_payload.version || github.event.inputs.cdk_version }}
        continue-on-error: true
        id: checkout_cdk

      - name: Retry CDK checkout on failure
        if: steps.checkout_cdk.outcome == 'failure'
        run: |
          echo "First checkout attempt failed, retrying..."
          sleep 5
          rm -rf cdk || true
          git clone --depth 1 --branch ${{ github.event.client_payload.version || github.event.inputs.cdk_version }} https://github.com/cashubtc/cdk.git cdk

      - name: Set up Python
        uses: actions/setup-python@v5.3.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel

      - name: Setup Rust cache
        uses: actions/cache@v4.1.2
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git
            ./cdk/target
          key: ${{ runner.os }}-cargo-macos-arm64-${{ hashFiles('cdk/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-macos-arm64-
            ${{ runner.os }}-cargo-

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.83.0
        with:
          toolchain: stable

      - name: Add ARM64 target
        run: rustup target add aarch64-apple-darwin

      - name: Build wheel
        run: |
          chmod +x scripts/generate-macos-arm64.sh
          ./scripts/generate-macos-arm64.sh
          python -m build --wheel

      - name: Upload wheel
        uses: actions/upload-artifact@v4.4.3
        with:
          name: wheel-macos-arm64-py${{ matrix.python-version }}
          path: dist/*.whl

  build-macos-x86_64:
    needs: update-version
    runs-on: macos-13
    if: contains(github.event.inputs.build_platforms, 'all') || contains(github.event.inputs.build_platforms, 'macos-x86_64')
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          ref: ${{ needs.update-version.outputs.commit_sha }}

      - name: Download version files
        uses: actions/download-artifact@v4.1.8
        with:
          name: version-files
          path: .

      - name: Checkout CDK repository
        uses: actions/checkout@v4.2.2
        with:
          repository: cashubtc/cdk
          path: cdk
          ref: ${{ github.event.client_payload.version || github.event.inputs.cdk_version }}
        continue-on-error: true
        id: checkout_cdk

      - name: Retry CDK checkout on failure
        if: steps.checkout_cdk.outcome == 'failure'
        run: |
          echo "First checkout attempt failed, retrying..."
          sleep 5
          rm -rf cdk || true
          git clone --depth 1 --branch ${{ github.event.client_payload.version || github.event.inputs.cdk_version }} https://github.com/cashubtc/cdk.git cdk

      - name: Set up Python
        uses: actions/setup-python@v5.3.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel

      - name: Setup Rust cache
        uses: actions/cache@v4.1.2
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git
            ./cdk/target
          key: ${{ runner.os }}-cargo-macos-x86_64-${{ hashFiles('cdk/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-macos-x86_64-
            ${{ runner.os }}-cargo-

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.83.0
        with:
          toolchain: stable

      - name: Add x86_64 target
        run: rustup target add x86_64-apple-darwin

      - name: Build wheel
        run: |
          chmod +x scripts/generate-macos-x86_64.sh
          ./scripts/generate-macos-x86_64.sh
          python -m build --wheel

      - name: Upload wheel
        uses: actions/upload-artifact@v4.4.3
        with:
          name: wheel-macos-x86_64-py${{ matrix.python-version }}
          path: dist/*.whl

  build-windows-x86_64:
    needs: update-version
    runs-on: windows-2022
    if: contains(github.event.inputs.build_platforms, 'all') || contains(github.event.inputs.build_platforms, 'windows-x86_64')
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          ref: ${{ needs.update-version.outputs.commit_sha }}

      - name: Download version files
        uses: actions/download-artifact@v4.1.8
        with:
          name: version-files
          path: .

      - name: Checkout CDK repository
        uses: actions/checkout@v4.2.2
        with:
          repository: cashubtc/cdk
          path: cdk
          ref: ${{ github.event.client_payload.version || github.event.inputs.cdk_version }}
        continue-on-error: true
        id: checkout_cdk

      - name: Retry CDK checkout on failure
        if: steps.checkout_cdk.outcome == 'failure'
        run: |
          echo "First checkout attempt failed, retrying..."
          sleep 5
          rm -rf cdk || true
          git clone --depth 1 --branch ${{ github.event.client_payload.version || github.event.inputs.cdk_version }} https://github.com/cashubtc/cdk.git cdk

      - name: Set up Python
        uses: actions/setup-python@v5.3.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel

      - name: Setup Rust cache
        uses: actions/cache@v4.1.2
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git
            ./cdk/target
          key: ${{ runner.os }}-cargo-windows-x86_64-${{ hashFiles('cdk/**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-windows-x86_64-
            ${{ runner.os }}-cargo-

      - name: Install Rust
        uses: dtolnay/rust-toolchain@1.83.0
        with:
          toolchain: stable

      - name: Add Windows target
        run: rustup target add x86_64-pc-windows-msvc

      - name: Build wheel
        shell: bash
        run: |
          chmod +x scripts/generate-windows-x86_64.sh
          ./scripts/generate-windows-x86_64.sh
          python -m build --wheel

      - name: Upload wheel
        uses: actions/upload-artifact@v4.4.3
        with:
          name: wheel-windows-x86_64-py${{ matrix.python-version }}
          path: dist/*.whl

  build-sdist:
    needs: update-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          ref: ${{ needs.update-version.outputs.commit_sha }}

      - name: Download version files
        uses: actions/download-artifact@v4.1.8
        with:
          name: version-files
          path: .

      - name: Set up Python
        uses: actions/setup-python@v5.3.0
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build source distribution
        run: python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4.4.3
        with:
          name: sdist
          path: dist/*.tar.gz

  publish:
    needs: [update-version, build-linux-x86_64, build-linux-aarch64, build-macos-arm64, build-macos-x86_64, build-windows-x86_64, build-sdist]
    runs-on: ubuntu-latest
    if: |
      always() &&
      !cancelled() &&
      needs.update-version.result == 'success' &&
      (github.event_name == 'repository_dispatch' || github.event.inputs.publish_target != 'none')
    steps:
      - uses: actions/checkout@v4.2.2
        with:
          ref: ${{ needs.update-version.outputs.commit_sha }}

      - name: Download version files
        uses: actions/download-artifact@v4.1.8
        with:
          name: version-files
          path: .

      - name: Set up Python
        uses: actions/setup-python@v5.3.0
        with:
          python-version: "3.10"

      - name: Extract version from pyproject.toml
        id: get_version
        run: |
          # Use grep/sed for compatibility with Python 3.10
          VERSION=$(grep "^version = " pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4.1.8
        with:
          path: dist-download/
          pattern: "{wheel-*,sdist}"
          merge-multiple: false

      - name: Prepare distribution files
        run: |
          mkdir -p dist
          cp dist-download/wheel-*/*.whl dist/ 2>/dev/null || true
          cp dist-download/sdist/*.tar.gz dist/ 2>/dev/null || true

      - name: Display distribution files
        run: |
          echo "ðŸ“¦ Distribution files:"
          ls -lh dist/
          echo ""
          echo "Target: ${{ github.event.inputs.publish_target || 'pypi' }}"

      - name: Determine PyPI repository URL
        id: pypi_url
        run: |
          PUBLISH_TARGET="${{ github.event.inputs.publish_target || 'pypi' }}"
          if [ "$PUBLISH_TARGET" = "test-pypi" ]; then
            echo "repository_url=https://test.pypi.org/legacy/" >> $GITHUB_OUTPUT
            echo "is_test=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Publishing to TestPyPI"
          else
            echo "repository_url=" >> $GITHUB_OUTPUT
            echo "is_test=false" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Publishing to PyPI"
          fi

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.12.2
        with:
          packages-dir: dist/
          print-hash: true
          repository-url: ${{ steps.pypi_url.outputs.repository_url }}
          skip-existing: true

      - name: Create GitHub Release
        if: success() && steps.pypi_url.outputs.is_test == 'false'
        uses: softprops/action-gh-release@v2.0.9
        with:
          files: dist/*
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Release v${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
